{%comment %}
async loader for youtube videos (copy from holusion.com)
Usage :
include youtube.html embed=##########
{%endcomment%}
<div class="media ratio ratio-16x9 youtube-video" data-embed="{{include.embed}}" >
  <div class="play-button">
  </div>
  <script defer>
    (async function(){ //Use an anonymous function to prevent poluting the global space
      const embed = '{{include.embed}}';
      const video = document.querySelector("[data-embed='"+embed+"']");

      // Load the image asynchronously
      youtube_thumbnails = [
         "https://img.youtube.com/vi/"+ embed +"/maxresdefault.jpg",
          "https://img.youtube.com/vi/"+ embed +"/hqdefault.jpg"
      ];
      for(let [index, thumb] of youtube_thumbnails.entries()){
        try{
          let image = await new Promise ( (resolve, reject) => {
            let image = new Image();
            image.src = thumb;
            image.addEventListener( "load", function() {resolve(image);});
            image.addEventListener("error", function(e){reject(e)});
          });
          if(image.width > 600 || index === youtube_thumbnails.length){
            console.log("Loaded youtube thumbnail");
            //If maxresdefault quality is good enough go for it. else load fallback
            video.insertBefore(image, video.firstChild);
            break;
          }
        }catch(e){
          console.log("Failed to load youtube thumbnail from %s :", thumb, e.message);
        }
      }

      video.addEventListener("click", function(){
        var iframe = document.createElement( "iframe" );
        iframe.className = "ratio";
        iframe.setAttribute( "frameborder", "0" );
        iframe.setAttribute( "allowfullscreen", "" );
        iframe.setAttribute("allow", "autoplay; encrypted-media; picture-in-picture");
        iframe.setAttribute( "src", "https://www.youtube.com/embed/"+ embed +"?rel=0&showinfo=0&autoplay=1");
        video.innerHTML = "";
        video.appendChild(iframe);
      })
    })()
  </script>
</div>
